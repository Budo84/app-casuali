<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pizze</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#e74c3c">
    <style>
        :root {
            --primary: #e74c3c;
            --bg: #f4f4f4;
            --text: #333;
            --card-bg: #fff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        header { background: var(--primary); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center; }
        h1 { margin: 0; font-size: 1.2rem; }

        .search-container { padding: 1rem; background: white; border-bottom: 1px solid #ddd; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        
        /* Filtri a pillola */
        .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
        .filter-chip { background: #eee; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: none; transition: 0.2s; white-space: nowrap;}
        .filter-chip.active { background: var(--primary); color: white; }

        /* Griglia Pizze */
        .pizza-list { padding: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .pizza-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; border-top: 4px solid #ccc; }
        .pizza-card.Rossa { border-top-color: var(--primary); }
        .pizza-card.Bianca { border-top-color: #bdc3c7; }

        /* Immagini */
        .pizza-img-container { width: 100%; height: 180px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .pizza-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .pizza-placeholder { font-size: 3rem; }

        /* Contenuto Card */
        .card-content { padding: 1rem; padding-top: 2.5rem; position: relative; }
        .card-header { margin-bottom: 5px; }
        .pizza-name { font-weight: bold; font-size: 1.1rem; }
        .pizza-season { font-size: 0.75rem; background: #e8f5e9; color: #2ecc71; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; display:inline-block; margin-top:4px;}
        .pizza-ingredients { font-size: 0.9rem; color: #666; line-height: 1.4; margin-top: 5px; }

        /* Bottoni Azione (Edit/Delete) */
        .card-actions { position: absolute; top: -20px; right: 10px; display: flex; gap: 8px; }
        .action-btn { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: none; background: white; }
        .edit-btn { color: #2980b9; }
        .delete-btn { color: #c0392b; }

        /* Modale */
        #addModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 20px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 1rem; margin-top: 10px; cursor: pointer; }
        .btn-secondary { background: #ddd; color: #333; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; cursor: pointer; }

        /* Upload Foto */
        .file-input-container { position: relative; margin-bottom: 15px; }
        .file-input-button { background: #3498db; color: white; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; display: block; }
        #newImageInput { position: absolute; top: 0; right: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        #imagePreview { max-width: 100%; max-height: 200px; display:none; border-radius: 8px; margin-top: 10px; margin: 0 auto; display: block;}

        /* FAB */
        .fab { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: none; z-index: 90; }
    </style>
</head>
<body>

<header>
    <h1>üçï Archivio Pizze</h1>
</header>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="Cerca pizza o ingrediente..." onkeyup="renderPizzas()">
    <div class="filters">
        <button class="filter-chip active" onclick="setFilter('Tutte', this)">Tutte</button>
        <button class="filter-chip" onclick="setFilter('Rossa', this)">Rosse</button>
        <button class="filter-chip" onclick="setFilter('Bianca', this)">Bianche</button>
    </div>
    <div class="filters" style="margin-top: 5px;">
        <select id="seasonFilter" onchange="renderPizzas()" style="padding: 5px; border-radius: 20px; border: 1px solid #ccc;">
            <option value="">üìÖ Tutte le stagioni</option>
            <option value="Tutto l'anno">Tutto l'anno</option>
            <option value="Estate">Estate</option>
            <option value="Inverno">Inverno</option>
            <option value="Primavera">Primavera</option>
            <option value="Autunno">Autunno</option>
        </select>
    </div>
</div>

<div class="pizza-list" id="pizzaList"></div>

<button class="fab" onclick="openModal()">+</button>

<div id="addModal">
    <div class="modal-content">
        <h2 id="modalTitle">Nuova Pizza</h2>
        
        <div class="file-input-container">
            <label class="file-input-button">üì∑ Scatta/Carica Foto</label>
            <input type="file" id="newImageInput" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
        </div>
        <img id="imagePreview" src="">
        <canvas id="compressionCanvas" style="display:none;"></canvas>

        <input type="text" id="newName" placeholder="Nome Pizza" style="margin-top:15px;">
        <select id="newCategory">
            <option value="Bianca">Bianca</option>
            <option value="Rossa">Rossa</option>
        </select>
        <select id="newSeason">
            <option value="Tutto l'anno">Tutto l'anno</option>
            <option value="Primavera">Primavera</option>
            <option value="Estate">Estate</option>
            <option value="Autunno">Autunno</option>
            <option value="Inverno">Inverno</option>
        </select>
        <textarea id="newIngredients" rows="3" placeholder="Ingredienti..."></textarea>
        
        <button class="btn-primary" onclick="savePizza()">Salva</button>
        <button class="btn-secondary" onclick="closeModal()">Annulla</button>
    </div>
</div>

<script>
    const rawCsvData = `id,Nome,Categoria,Ingrediente1,Ingrediente2,Ingrediente3,Ingrediente4,Ingrediente5,Ingrediente6,Ingrediente7,Ingrediente8,Ingrediente9,Ingrediente10
1,Margherita,Rossa,pomodoro,fior di latte,,parmigiano,,parmigiano,basilico,,olio,sale
2,Margherita con bufala,Rossa,pomodoro,mozzarella di bufala,,parmigiano,,parmigiano,basilico,,olio,sale
3,Bianca,Bianca,,,,,,,,,olio,sale
4,Rossa con origano,Rossa,pomodoro,,,,,,origano,,olio,sale
5,Patate,Bianca,patate,,,,,,rosmarino,,olio,sale
6,Zucchine,Bianca,zucchine,fior di latte,,,,,,,olio,sale
7,Funghi bianca,Bianca,funghi,fior di latte,,,,,prezzemolo,,olio,sale
8,Amatriciana,Rossa,pomodoro,guanciale,,,,pecorino,,pepe,olio,sale
9,Carbonara,Bianca,uovo,guanciale,,,,pecorino,,pepe,olio,sale
10,Cacio e Pepe,Bianca,ghiaccio,,,,,pecorino,,pepe,olio,sale
11,"Gorgonzola, mozzarella, in uscita pere (sottili), guanciale croccante e miele",Bianca,gorgonzola,pere,guanciale,miele,fior di latte,,,,olio,sale
12,"Base rossa, melanzane grigliate in uscita capocollo e burrata",Rossa,pomodoro,melanzane,capocollo,burrata,,,,,olio,sale
13,Broccoletti e salsiccia,Bianca,broccoletti,salsiccia,,,,,,,olio,sale
14,Patate e salsiccia,Bianca,patate,salsiccia,,,,,,,olio,sale
15,Provola affumicata e speck,Bianca,provola,speck,fior di latte,,,,,,olio,sale
16,Vergure grigliate,Bianca,zucchine,melanzane,peperoni,fior di latte,,,,,olio,sale
17,"Base rossa, bresaola rughetta e parmigiano",Rossa,pomodoro,bresaola,rughetta,parmigiano,,,,,olio,sale
18,Stracchino e ciasculo,Bianca,stracchino,ciauscolo,fior di latte,,,,,,olio,
19,"Zucchine, melanzane e peperoni",Bianca,zucchine,melanzane,peperoni,,,,,,olio,sale
20,Zucca e speck,Bianca,zucca,speck,,,,,,,olio,sale
21,"Fiori di zucca, crema di zucchine e alici",Bianca,fiori di zucca,zucchine,alici,,,,,,olio,sale
22,"Nduia, peperoni, alici, cipolla, rosmarino e bufala in uscita",Bianca,nduia,peperoni,alici,cipolla,mozzarella di bufala,,rosmarino,,olio,sale
23,Pizza fritta pomodoro e parmigiano,Rossa,pomodoro,,,,,parmigiano,basilico,,olio,sale
24,Cicoria e salsiccia,Bianca,salsiccia,cicoria,peperoncino,,,,,,olio,sale
25,"Crema di ceci, mortadella, limone",Bianca,ceci,mortadella,limone,,,,,,olio,sale
26,Asparagi e crema di pecorino,Bianca,asparagi,,,,,pecorino,,,olio,sale
27,Cime di rapa e salsiccia,Bianca,cime di rapa,salsiccia,,,,,,,olio,sale
28,Funghi rossa,Rossa,pomodoro,funghi,fior di latte,,,,,,olio,sale
29,Boscaiola bianca,Bianca,funghi,salsiccia,mozzarella,,,,,,olio,sale
30,Zucca e grana,Bianca,zucca,parmigiano,,,,,,,olio,sale
31,Zucca e gorgonzola,Bianca,zucca,gorgonzola,,,,,,,olio,sale
32,"Zucchine, ciauscolo e cipolla",Bianca,zucchine,ciauscolo,cipolla,,,,,,olio,sale
33,"Base rossa, ricotta e granella di pistacchio",Rossa,pomodoro,ricotta,pistacchio,,,,,,olio,sale
34,"Crema di asparagi, punte di asparagi e speck croccante in uscita",Bianca,asparagi,speck,,,,,,,olio,sale
35,Tonno e cipolla,Rossa,pomodoro,tonno,cipolla,,,,,,olio,sale
36,Peperoni e salsiccia,Bianca,peperoni,salsiccia,,,,,,,olio,sale
37,Mela e lardo di colonnata,Bianca,mela,lardo,,,,,,,olio,sale
38,Focaccia bianca,Bianca,,,,,,,,,olio,sale
39,"Focaccia pomodorini, olive nere e origano",Bianca,pomodorini,olive nere,,,,,origano,,olio,sale
40,Melanzane,Bianca,melanzane,fior di latte,,,,,,,olio,sale
41,Gorgonzola,Bianca,gorgonzola,fior di latte,,,,,,,olio,sale
42,4 Formaggi,Bianca,gorgonzola,parmigiano,stracchino,pecorino,,,,,olio,sale
43,"Mortadella, Maionese di Pistacchio e Stracciatella in uscita",Bianca,mortadella,pistacchio,stracciatella,,,,,,olio,sale
44,"Patate, Stracchino e Cipolla",Bianca,patate,stracchino,cipolla,,,,,,olio,sale
45,Margherita con Prosciutto crudo,Rossa,pomodoro,prosciutto crudo,,,,,,,olio,sale
46,"Bieta, Olive nere e Peperoncino",Bianca,bieta,olive nere,peperonicino,,,,,,olio,sale
47,"Cipolline Borretane in agro dolce, Fior di Latte, Alici e Pecorino Romano",Bianca,cipolle,fior di latte,alici,zucchero,aceto,pecorino,,,olio,sale
48,"Base rossa, puntarelle con olio e aceto e Alici",Rossa,pomodoro,puntarelle,aceto,alici,,,,,olio,sale
49,Crostino (Cotto e Mozzarella),Bianca,prosciutto cotto,fior di latte,,,,,,,olio,sale
50,Broccoletti stufati con alici e pecorino,Bianca,broccoletti,alici,,,,pecorino,,,olio,sale
51,"Base rossa, Peperoni al forno con Alici, Capperi, Olive verdi e Pane grattato",Rossa,peperoni,alici,capperi,olive verdi,pane grattato,,,,olio,sale
52,Patate al forno (aglio e rosmarino) e Mozzarella,Bianca,patate,fior di latte,aglio,,,,rosmarino,,olio,sale
53,"Crema di Friarielli (con latte di Bufala Affumicata), Fiordilatte, Bufala Affumicata e salsiccia",Bianca,friarielli,mozzarella di bufala affumicata,fior di latte,salsiccia,,,,,olio,sale
54,"Crema di Zucchine, Melanzane Grigliate, Ricotta e Parmigiano",Bianca,zucchine,melanzane,ricotta,,,parmigiano,,,olio,sale
55,"Patate, fiori di zucca, pesto alla genovese e fior di latte",Bianca,patate,fiori di zucca,pesto,fior di latte,,,,,olio,sale
56,"Carciofi alla romana, guanciale e pecorino",Bianca,carciofi,guanciale,,,aglio,pecorino,mentuccia,,olio,sale
57,"Cicoria ripassata, alici e pecorino",Bianca,cicoria,alici,,,,pecorino,,,olio,sale
58,"Base bianca, squacquerone, prosciutto crudo",Bianca,prosciutto crudo,squacquerone,,,,,,,olio,sale
59,Base rossa pomodorini confit e stracciatella in uscita,Rossa,pomodoro,pomodorini,zucchero,stracciatella,,,,,olio,sale
60,"Base bianca, fave (poca mozzarella e met√† cottura) e pecorino in uscita",Bianca,fave,fior,,,,pecorino,,,olio,sale
61,Fiori di zucca alici e ricotta,Bianca,fiori di zucca,alici,ricotta,,,,,,olio,sale
62,Fiori di zucca prosciutto cotto (mozzarella o ricotta),Bianca,fiori di zucca,prosciutto cotto,fior di latte,,,,,,olio,sale
63,Carciofi alla romana prosciutto arrosto alla griglia e stracciatella in uscita,Bianca,carciofi,prosciutto arrosto,stracciatella,,,,,,olio,sale
64,Zucchine mozzarella e stracchino (prova foglioline di menta),Bianca,stracchino,fior di latte,,,,,menta,,olio,sale
65,Zucchine e in uscita salmone affumicato e stracciatella,Bianca,zucchine,salmone affumicato,stracciatella,,,,,,olio,sale
66,"Prosciutto cotto al forno, mozzarella e funghi champignon",Bianca,prosciutto cotto al forno,fior di latte,funghi,,,,,,olio,sale
67,"Peperoni cornetti, cipolle, mozzarella e gorgonzola",Bianca,peperoni cornetti,cipolla,fior di latte,gorgonzola,,,,,olio,sale
68,"Crema di patate (pur√©),scamorza affumicata, fiori di zucca, fior di latte",Bianca,patate,scamorza affumicata,fiori di zucca,fior di latte,,,,,olio,sale
69,"Base rossa, scarola, alici, uvetta, pinoli",Rossa,scarola,uvetta,alici,pinoli,,,,,olio,sale
70,"Crema di zucca, patate, fior di latte, gorgonzola",Bianca,patate,fior di latte,zucca,gorgonzola,,,,,olio,sale
71,Norma a modo mio,Rossa,melanzane,ricotta salata,parmigliano,,,,,,olio,sale
72,"Base rossa, rughetta, crudo e bufala",Rossa,pomodoro,prosciutto crudo,rughetta,bufala,,,,,olio,sale
73,"Base bianca, stracchino, gorgonzola e speck in uscita",Bianca,gorgonzola,stracchino,speck,,,,,,olio,sale
74,"Base bianca, carciofi alla romana, pancetta tesa, saba",Bianca,carciofi,pancetta,saba,,,,,,olio,sale`;

    let pizzas = [];
    let currentFilter = 'Tutte';
    let tempImageBase64 = null;
    let editingId = null;

    function init() {
        // Carica dati
        const stored = localStorage.getItem('pizzaDb_v3');
        if (stored) {
            pizzas = JSON.parse(stored);
        } else {
            parseCSV(rawCsvData);
        }
        renderPizzas();

        // REGISTRAZIONE SERVICE WORKER (Percorso Relativo per sottocartella 'pizza')
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('SW Registered in ./pizza/'))
            .catch(err => console.error('SW Error:', err));
        }
    }

    function parseCSV(csv) {
        const lines = csv.split('\n');
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if(!line) continue;
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(parts.length < 3) continue;

            const name = parts[1].replace(/"/g, '').trim();
            const cat = parts[2].trim();
            const ingredients = [];
            for(let j=3; j<=12; j++) {
                if(parts[j] && parts[j].trim() !== '') {
                    ingredients.push(parts[j].replace(/"/g, '').trim().toLowerCase());
                }
            }
            pizzas.push({
                id: Date.now() + i,
                name: name,
                category: cat,
                season: "Tutto l'anno",
                ingredients: ingredients,
                image: null
            });
        }
        saveData();
    }

    function saveData() {
        try {
            localStorage.setItem('pizzaDb_v3', JSON.stringify(pizzas));
            renderPizzas();
        } catch(e) { alert('Memoria piena! Cancella qualche foto.'); }
    }

    // Compressione Immagini
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.getElementById('compressionCanvas');
                const ctx = canvas.getContext('2d');
                const MAX_W = 400; 
                const scale = MAX_W / img.width;
                canvas.width = MAX_W;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                tempImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('imagePreview').src = tempImageBase64;
                document.getElementById('imagePreview').style.display = 'block';
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    // UI & Logica
    function setFilter(type, btn) {
        currentFilter = type;
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderPizzas();
    }

    function renderPizzas() {
        const list = document.getElementById('pizzaList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const season = document.getElementById('seasonFilter').value;
        list.innerHTML = '';

        const filtered = pizzas.filter(p => {
            if(currentFilter !== 'Tutte' && p.category !== currentFilter) return false;
            if(season && p.season !== season) return false;
            return p.name.toLowerCase().includes(search) || p.ingredients.some(i => i.includes(search));
        });

        filtered.forEach(p => {
            const imgHtml = p.image 
                ? `<div class="pizza-img-container"><img src="${p.image}"></div>` 
                : `<div class="pizza-img-container"><span class="pizza-placeholder">üçï</span></div>`;
            
            const div = document.createElement('div');
            div.className = `pizza-card ${p.category}`;
            div.innerHTML = `
                ${imgHtml}
                <div class="card-content">
                    <div class="card-actions">
                        <button class="action-btn edit-btn" onclick="openModal(${p.id})">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="deletePizza(${p.id})">&times;</button>
                    </div>
                    <div class="card-header">
                        <div class="pizza-name">${p.name}</div>
                        <span class="pizza-season">${p.season}</span>
                    </div>
                    <div class="pizza-ingredients">${p.ingredients.join(', ')}</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function openModal(id = null) {
        editingId = id;
        tempImageBase64 = null;
        document.getElementById('imagePreview').style.display = 'none';
        
        if(id) {
            const p = pizzas.find(x => x.id === id);
            document.getElementById('modalTitle').innerText = 'Modifica Pizza';
            document.getElementById('newName').value = p.name;
            document.getElementById('newCategory').value = p.category;
            document.getElementById('newSeason').value = p.season;
            document.getElementById('newIngredients').value = p.ingredients.join(', ');
            if(p.image) {
                tempImageBase64 = p.image;
                document.getElementById('imagePreview').src = p.image;
                document.getElementById('imagePreview').style.display = 'block';
            }
        } else {
            document.getElementById('modalTitle').innerText = 'Nuova Pizza';
            document.getElementById('newName').value = '';
            document.getElementById('newIngredients').value = '';
        }
        document.getElementById('addModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('addModal').style.display = 'none'; }

    function savePizza() {
        const name = document.getElementById('newName').value;
        if(!name) return alert('Nome obbligatorio');
        
        const cat = document.getElementById('newCategory').value;
        const season = document.getElementById('newSeason').value;
        const ings = document.getElementById('newIngredients').value.split(',').map(s=>s.trim().toLowerCase()).filter(s=>s);

        if(editingId) {
            const idx = pizzas.findIndex(p => p.id === editingId);
            pizzas[idx] = { ...pizzas[idx], name, category: cat, season, ingredients: ings, image: tempImageBase64 || pizzas[idx].image };
        } else {
            pizzas.unshift({ id: Date.now(), name, category: cat, season, ingredients: ings, image: tempImageBase64 });
        }
        saveData();
        closeModal();
    }

    function deletePizza(id) {
        if(confirm('Eliminare?')) {
            pizzas = pizzas.filter(p => p.id !== id);
            saveData();
        }
    }

    init();
</script>
</body>
</html>
