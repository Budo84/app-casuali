<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Spesa Smart & Family</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --primary: #2E7D32; --bg: #f5f5f5; --card: #fff; --text: #333; --accent: #ff9800; --danger: #d32f2f; --lock: #C2185B; --price: #00897b; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; user-select: none; }
        
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top:0; z-index:100; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-badge { display: flex; align-items: center; font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 6px; }
        .dot.online { background: #00E676; box-shadow: 0 0 5px #00E676; }

        .page { display: none; padding: 15px; animation: slideIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .card { background: var(--card); padding: 0; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        .day-header { background: #e8f5e9; color: var(--primary); padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #c8e6c9; }
        .meal-row { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; position: relative; }
        .meal-content { flex: 1; padding-right: 80px; } /* Spazio per bottoni */
        .meal-title { font-weight: 600; font-size: 1rem; color: #444; }
        .meal-ing { font-size: 0.85rem; color: #777; margin-top: 2px; }
        .meal-actions { position: absolute; right: 10px; top: 12px; display: flex; gap: 5px; }
        .action-btn { cursor: pointer; color: #ccc; font-size: 1.3rem; padding: 2px; }
        .action-btn:hover { color: var(--primary); }
        .action-btn.active-lock { color: var(--lock); }
        .action-btn.active-fav { color: var(--danger); }
        
        .allergen-warning { color: var(--danger); font-size: 0.75rem; display: flex; align-items: center; margin-top: 4px; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 4px; display: inline-flex;}

        /* LISTA SPESA */
        .add-item-box { display: flex; gap: 10px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .add-item-box input { flex: 1; padding: 8px; border: none; outline: none; font-size: 1rem; }
        .add-item-box button { background: var(--primary); color: white; border: none; width: 40px; border-radius: 4px; font-size: 1.2rem; cursor: pointer; }
        .shop-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .shop-item.checked { opacity: 0.6; background: #f9f9f9; }
        .input-qty { width: 50px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; background: #f0f8ff; }
        .input-price { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .input-price.auto-price { background: #e0f2f1; color: #00695c; font-weight: bold; border: 1px solid #b2dfdb; }
        .total-float { position: fixed; bottom: 80px; left: 15px; right: 15px; background: #333; color: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 900; }

        .offer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .offer-card { background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; text-align: center; cursor: pointer; }

        .family-chip { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; display: inline-flex; align-items: center; margin-right: 5px; margin-bottom: 5px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group input, .input-group select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }

        .settings-box { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        .nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; height: 65px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav a { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; text-decoration: none; font-size: 0.75rem; }
        .nav a.active { color: var(--primary); font-weight: bold; }
        .nav i { font-size: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; flex-direction:column;">
        <span style="font-weight:bold; font-size:1.1rem;">Spesa Smart</span>
        <small style="font-size:0.7rem; opacity:0.9">Dieta Flessibile</small>
    </div>
    <div class="status-badge">
        <div id="statusDot" class="dot"></div>
        <span id="statusText">Sync</span>
    </div>
</header>

<div id="p-menu" class="page active">
    <div class="settings-box" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <label style="font-size:0.8rem; color:#666; display:block;">Stile Dieta</label>
            <select id="dietType" onchange="saveDietSettings()" style="border:none; background:transparent; font-weight:bold; color:var(--primary); font-size:1rem;">
                <option value="mediterranea">Mediterranea</option>
                <option value="vegetariana">Vegetariana</option>
                <option value="mondo">Dal Mondo</option>
                <option value="mix">Misto (Sorpresa)</option>
            </select>
        </div>
        <button class="btn btn-outline" style="width:auto; margin:0; padding:8px 15px;" onclick="generateMenu(true)">
            <i class="material-icons" style="vertical-align:middle;">autorenew</i>
        </button>
    </div>

    <div id="menuList" style="padding-bottom: 20px;"></div>
</div>

<div id="p-spesa" class="page">
    <h3>üõí Lista della Spesa</h3>
    <div class="add-item-box">
        <input type="text" id="manualItemName" placeholder="Aggiungi prodotto...">
        <button onclick="addManualItem()">+</button>
    </div>
    <div id="shopList" style="padding-bottom: 80px;"></div>
    <div class="total-float">
        <span style="font-size:0.9rem; opacity:0.8;">Totale Stimato</span>
        <span id="totalPrice" style="font-size:1.4rem; font-weight:bold; color:#b2dfdb;">‚Ç¨ 0.00</span>
    </div>
</div>

<div id="p-offerte" class="page">
    <h3>Offerte dal Volantino</h3>
    <select id="storeSelect" onchange="renderOffers()" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;"></select>
    <div id="offerList" class="offer-grid"></div>
</div>

<div id="p-famiglia" class="page">
    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famiglia & Salute</h3>
    <div class="input-group">
        <input type="text" id="memberName" placeholder="Nome">
        <select id="memberAllergy">
            <option value="">Nessuna allergia</option>
            <option value="Glutine">Glutine</option>
            <option value="Lattosio">Lattosio</option>
            <option value="Uova">Uova</option>
            <option value="Pesce">Pesce</option>
            <option value="Frutta a guscio">Frutta a guscio</option>
            <option value="Diabete">Diabete (Zuccheri)</option>
        </select>
    </div>
    <button class="btn" onclick="addFamilyMember()">Aggiungi Membro</button>
    <div id="familyContainer" style="margin-top:15px; margin-bottom:20px;"></div>

    <hr style="border:0; border-top:1px solid #eee;">
    
    <h3>‚öôÔ∏è Configurazione</h3>
    <div class="settings-box">
        <input type="text" id="ghRepo" placeholder="Repo GitHub" style="width:100%; padding:8px; margin-bottom:5px; border:1px solid #ddd;">
        <input type="password" id="ghToken" placeholder="Token GitHub" style="width:100%; padding:8px; margin-bottom:5px; border:1px solid #ddd;">
        <button onclick="saveCreds()" style="padding:5px; width:100%;">Salva Login</button>
        
        <div style="margin-top:15px;">
            <label>Carica PDF:</label>
            <input type="text" id="pdfName" placeholder="Nome Supermercato" style="width:100%; margin-top:5px; padding:8px; border:1px solid #ddd;">
            <input type="file" id="pdfFile" accept="application/pdf" style="margin-top:5px;">
        </div>
        <button class="btn" onclick="uploadPDF()" id="btnUp">‚¨ÜÔ∏è Carica e Analizza</button>
        <p id="upStatus" style="font-size:0.8rem; color:#666; margin-top:5px;"></p>
    </div>
    <button class="btn" style="background:var(--danger);" onclick="hardReset()">‚ö†Ô∏è Reset App</button>
</div>

<nav class="nav">
    <a onclick="go('p-menu', this)" class="active"><i class="material-icons">restaurant_menu</i>Menu</a>
    <a onclick="go('p-spesa', this)"><i class="material-icons">shopping_cart</i>Spesa</a>
    <a onclick="go('p-offerte', this)"><i class="material-icons">local_offer</i>Offerte</a>
    <a onclick="go('p-famiglia', this)"><i class="material-icons">settings</i>Opz</a>
</nav>

<script>
    // --- STATO DATI ---
    let db = null;
    let menu = JSON.parse(localStorage.getItem('smart_menu')) || [];
    let family = JSON.parse(localStorage.getItem('smart_family')) || [];
    let locked = JSON.parse(localStorage.getItem('smart_locked')) || {};
    let favorites = JSON.parse(localStorage.getItem('smart_fav')) || [];
    let shopData = JSON.parse(localStorage.getItem('smart_shop_data')) || {}; 
    let dietSettings = localStorage.getItem('smart_diet') || 'mediterranea';

    // DIZIONARIO RISCHI
    const riskMap = {
        "Glutine": ["pane", "pasta", "farina", "biscotti", "cereali", "orzo", "farro", "pizza", "focaccia"],
        "Lattosio": ["latte", "yogurt", "formaggio", "mozzarella", "burro", "panna", "parmigiano", "ricotta"],
        "Uova": ["uova", "frittata", "mayonese", "crema", "carbonara"],
        "Pesce": ["pesce", "tonno", "merluzzo", "salmone", "sogliola", "gamberi", "cozze", "vongole"],
        "Frutta a guscio": ["noci", "mandorle", "nocciole", "pistacchi", "anacardi", "arachidi", "pesto"],
        "Diabete": ["zucchero", "miele", "cioccolato", "torta", "biscotti", "dolce", "marmellata", "succo", "sciroppo", "bevanda", "canditi"]
    };

    async function init() {
        renderFamily();
        document.getElementById('dietType').value = dietSettings;
        if(localStorage.getItem('gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('gh_repo');
        if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');
        
        updateStatus('loading');
        try {
            const res = await fetch('dati_settimanali.json?t=' + Date.now());
            if(!res.ok) throw new Error("JSON 404");
            db = await res.json();
            updateStatus('online');
            
            const sel = document.getElementById('storeSelect');
            sel.innerHTML = "";
            const stores = Object.keys(db.offerte_per_supermercato || {});
            if(stores.length>0) {
                stores.forEach(s => { let opt=document.createElement('option'); opt.value=s; opt.innerText=s; sel.appendChild(opt); });
                sel.value = stores[0];
            } else { sel.innerHTML = "<option>Nessun Volantino</option>"; }

            // Se il menu √® vecchio o vuoto, rigenera
            if(!menu.length) generateMenu(false);
            renderAll();
        } catch(e) {
            console.error(e);
            updateStatus('offline');
            if(menu.length) renderAll();
        }
    }

    function updateStatus(s) {
        document.getElementById('statusDot').className = 'dot ' + s;
        document.getElementById('statusText').innerText = s === 'online' ? 'Aggiornato' : 'Offline';
    }

    // --- LOGICA MENU AVANZATA ---
    function saveDietSettings() {
        dietSettings = document.getElementById('dietType').value;
        localStorage.setItem('smart_diet', dietSettings);
        // Quando cambi dieta, chiediamo se vuole rigenerare? Meglio farlo manuale
    }

    function getPoolForMeal(type) {
        // Recupera le ricette dal "database_ricette" in base alla dieta scelta
        // Se db.database_ricette non esiste (vecchio json), usa fallback vuoto
        if(!db || !db.database_ricette) return [];

        let pools = [];
        
        if(dietSettings === 'mix') {
            // Unisce tutte le categorie
            Object.keys(db.database_ricette).forEach(cat => {
                if(db.database_ricette[cat][type]) pools = pools.concat(db.database_ricette[cat][type]);
            });
        } else {
            // Usa solo la categoria scelta
            if(db.database_ricette[dietSettings] && db.database_ricette[dietSettings][type]) {
                pools = db.database_ricette[dietSettings][type];
            }
        }
        return pools;
    }

    function pickSafeRecipe(pool, currentTitleToAvoid) {
        // 1. Filtra per evitare ricette con allergeni della famiglia
        let safePool = pool.filter(r => checkAllergens(r.ingredients) === null);
        
        // Se non ci sono ricette sicure, usa tutto il pool (ma segnaler√† l'errore)
        if(safePool.length === 0) safePool = pool;
        
        // 2. Filtra per non ripetere lo stesso piatto che stiamo cambiando
        if(currentTitleToAvoid) safePool = safePool.filter(r => r.title !== currentTitleToAvoid);
        
        if(safePool.length === 0) return {title: "Pasto Libero", ingredients: []};
        return safePool[Math.floor(Math.random() * safePool.length)];
    }

    function generateMenu(force) {
        const days = ['Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato','Domenica'];
        const types = ['colazione','pranzo','merenda','cena'];
        let newMenu = force ? [] : menu;

        for(let i=0; i<7; i++) {
            if(!force && newMenu[i]) continue;
            let dayObj = { day: days[i], meals: {} };
            
            types.forEach(t => {
                let k = `${i}_${t}`;
                if(locked[k] && force) {
                    dayObj.meals[t] = locked[k];
                } else {
                    let pool = getPoolForMeal(t);
                    let pick = pickSafeRecipe(pool, null);
                    dayObj.meals[t] = pick;
                }
            });
            if(force) newMenu.push(dayObj); else newMenu[i] = dayObj;
        }
        menu = newMenu;
        localStorage.setItem('smart_menu', JSON.stringify(menu));
        updateShopDataFromMenu(); 
        renderAll();
    }

    // --- CAMBIO SINGOLO PIATTO (Doppia Scelta) ---
    function swapMeal(dayIdx, type) {
        if(locked[`${dayIdx}_${type}`]) return alert("Sblocca il piatto prima di cambiarlo!");
        
        let currentMeal = menu[dayIdx].meals[type];
        let pool = getPoolForMeal(type);
        let newMeal = pickSafeRecipe(pool, currentMeal.title);
        
        menu[dayIdx].meals[type] = newMeal;
        localStorage.setItem('smart_menu', JSON.stringify(menu));
        updateShopDataFromMenu();
        renderAll();
    }

    // --- LISTA SPESA (Invariata ma vitale) ---
    function updateShopDataFromMenu() {
        let menuNeeds = {};
        menu.forEach(d => Object.values(d.meals).forEach(m => {
            if(m.ingredients) m.ingredients.forEach(i => menuNeeds[i] = (menuNeeds[i]||0)+1);
        }));

        let newShopData = {};
        Object.keys(menuNeeds).forEach(item => {
            let existing = shopData[item];
            if(existing) {
                newShopData[item] = { qty: menuNeeds[item], price: existing.price, checked: existing.checked, isManual: false, isOffer: existing.isOffer };
            } else {
                newShopData[item] = { qty: menuNeeds[item], price: 0, checked: false, isManual: false, isOffer: false };
            }
            if(!newShopData[item].price) {
                let offer = findOfferPrice(item);
                if(offer > 0) { newShopData[item].price = offer; newShopData[item].isOffer = true; }
            }
        });

        Object.keys(shopData).forEach(item => { if(shopData[item].isManual) newShopData[item] = shopData[item]; });
        shopData = newShopData;
        localStorage.setItem('smart_shop_data', JSON.stringify(shopData));
    }

    function findOfferPrice(itemName) {
        if(!db || !db.offerte_per_supermercato) return 0;
        let best = 0;
        Object.values(db.offerte_per_supermercato).forEach(list => {
            let match = list.find(o => o.name.toLowerCase().includes(itemName.toLowerCase()));
            if(match) best = match.price;
        });
        return best;
    }

    function addManualItem() {
        let name = document.getElementById('manualItemName').value.trim();
        if(!name) return;
        name = name.charAt(0).toUpperCase() + name.slice(1);
        if(!shopData[name]) {
            shopData[name] = { qty: 1, price: 0, checked: false, isManual: true, isOffer: false };
            let offer = findOfferPrice(name);
            if(offer > 0) { shopData[name].price = offer; shopData[name].isOffer = true; }
        } else { shopData[name].qty++; shopData[name].isManual = true; }
        document.getElementById('manualItemName').value = "";
        localStorage.setItem('smart_shop_data', JSON.stringify(shopData));
        renderShop();
    }

    function renderShop() {
        const c = document.getElementById('shopList'); c.innerHTML = "";
        let total = 0;
        let keys = Object.keys(shopData).sort((a,b) => (shopData[a].checked === shopData[b].checked) ? a.localeCompare(b) : (shopData[a].checked ? 1 : -1));

        if(keys.length === 0) {
            c.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px'>Lista vuota.</p>";
            document.getElementById('totalPrice').innerText = "‚Ç¨ 0.00";
            return;
        }

        keys.forEach(name => {
            let item = shopData[name];
            let sub = item.qty * item.price;
            if(!item.checked) total += sub;
            let priceClass = item.isOffer ? 'auto-price' : '';

            c.innerHTML += `
            <div class="shop-item ${item.checked?'checked':''}">
                <div class="shop-header">
                    <span class="item-name">${name} ${item.isManual ? '<small style="color:#ff9800">*</small>' : ''}</span>
                    <div style="display:flex; align-items:center;">
                        ${item.isManual ? `<i class="material-icons delete-item" onclick="deleteItem('${name}')">delete</i>` : ''}
                        <i class="material-icons check-btn ${item.checked?'checked':''}" onclick="toggleCheck('${name}')">check_circle</i>
                    </div>
                </div>
                <div class="item-inputs">
                    <input type="number" class="input-qty" value="${item.qty}" min="1" onchange="updateShopItem('${name}', 'qty', this.value)">
                    <span style="font-size:0.9rem;">x</span>
                    <input type="number" class="input-price ${priceClass}" value="${item.price}" step="0.01" placeholder="Prezzo" onchange="updateShopItem('${name}', 'price', this.value)">
                </div>
            </div>`;
        });
        document.getElementById('totalPrice').innerText = "‚Ç¨ " + total.toFixed(2);
    }

    function updateShopItem(name, field, val) {
        if(!shopData[name]) return;
        shopData[name][field] = parseFloat(val) || 0;
        if(field === 'price') shopData[name].isOffer = false;
        localStorage.setItem('smart_shop_data', JSON.stringify(shopData));
        renderShop();
    }

    function toggleCheck(name) {
        if(shopData[name]) shopData[name].checked = !shopData[name].checked;
        localStorage.setItem('smart_shop_data', JSON.stringify(shopData));
        renderShop();
    }

    function deleteItem(name) {
        if(confirm(`Rimuovere ${name}?`)) { delete shopData[name]; localStorage.setItem('smart_shop_data', JSON.stringify(shopData)); renderShop(); }
    }

    // --- OFFERTE ---
    function renderOffers() {
        const c = document.getElementById('offerList'); c.innerHTML = "";
        const s = document.getElementById('storeSelect').value;
        if(!s || !db.offerte_per_supermercato || !db.offerte_per_supermercato[s]) return;

        db.offerte_per_supermercato[s].forEach(o => {
            c.innerHTML += `<div class="offer-card" onclick="addOfferToList('${o.name}', ${o.price})"><div style="font-size:0.9rem; margin-bottom:5px;">${o.name}</div><div class="offer-price">‚Ç¨${o.price.toFixed(2)}</div><small style="color:#2E7D32">+ Aggiungi</small></div>`;
        });
    }

    function addOfferToList(name, price) {
        if(!shopData[name]) shopData[name] = { qty: 1, price: price, checked: false, isManual: true, isOffer: true };
        else { shopData[name].price = price; shopData[name].isOffer = true; }
        localStorage.setItem('smart_shop_data', JSON.stringify(shopData));
        alert(`Aggiunto: ${name}`);
        renderShop();
    }

    // --- RENDER MENU & UI ---
    function renderMenu() {
        const c = document.getElementById('menuList'); c.innerHTML = "";
        menu.forEach((d, dayIdx) => {
            let html = `<div class="card"><div class="day-header">${d.day}</div>`;
            ['colazione','pranzo','merenda','cena'].forEach(t => {
                let m = d.meals[t];
                let k = `${dayIdx}_${t}`;
                let isL = !!locked[k];
                let isF = favorites.includes(m.title);
                let w = checkAllergens(m.ingredients);
                let ico = t==='colazione'?'‚òï': t==='pranzo'?'üçù': t==='merenda'?'üçé':'üåô';
                
                html += `
                <div class="meal-row">
                    <div style="font-size:24px; width:35px;">${ico}</div>
                    <div class="meal-content">
                        <div class="meal-title">${m.title}</div>
                        <div class="meal-ing">${m.ingredients?m.ingredients.join(', '):''}</div>
                        ${w?`<div class="allergen-warning"><i class="material-icons">warning</i> ${w}</div>`:''}
                    </div>
                    <div class="meal-actions">
                        <i class="material-icons action-btn" onclick="swapMeal(${dayIdx},'${t}')" title="Cambia Piatto">sync</i>
                        <i class="material-icons action-btn ${isF?'active-fav':''}" onclick="toggleFav('${m.title}')">${isF?'favorite':'favorite_border'}</i>
                        <i class="material-icons action-btn ${isL?'active-lock':''}" onclick="toggleLock(${dayIdx},'${t}')">${isL?'lock':'lock_open'}</i>
                    </div>
                </div>`;
            });
            c.innerHTML += html + "</div>";
        });
    }

    function checkAllergens(ings) {
        if(!ings) return null;
        let hits = [];
        family.forEach(f => {
            if(f.allergy) {
                let keywords = riskMap[f.allergy] || [f.allergy.toLowerCase()];
                if(ings.some(ing => keywords.some(key => ing.toLowerCase().includes(key)))) hits.push(f.name);
            }
        });
        return hits.length ? "‚ö†Ô∏è No per: " + hits.join(', ') : null;
    }

    function toggleLock(d,t){ let k=`${d}_${t}`; if(locked[k]) delete locked[k]; else locked[k]=menu[d].meals[t]; localStorage.setItem('smart_locked',JSON.stringify(locked)); renderMenu(); }
    function toggleFav(t){ if(favorites.includes(t)) favorites=favorites.filter(x=>x!==t); else favorites.push(t); localStorage.setItem('smart_fav',JSON.stringify(favorites)); renderMenu(); }
    
    function addFamilyMember() { let n=document.getElementById('memberName').value, a=document.getElementById('memberAllergy').value; if(n){ family.push({name:n, allergy:a}); localStorage.setItem('smart_family',JSON.stringify(family)); renderFamily(); renderMenu(); } }
    function renderFamily() { document.getElementById('familyContainer').innerHTML = family.map((f,i)=>`<div class="family-chip">${f.name} ${f.allergy||''} <i class="material-icons" style="font-size:16px; margin-left:5px; cursor:pointer" onclick="family.splice(${i},1); localStorage.setItem('smart_family',JSON.stringify(family)); renderFamily(); renderMenu();">close</i></div>`).join(''); }

    function saveCreds() { localStorage.setItem('gh_repo', document.getElementById('ghRepo').value); localStorage.setItem('gh_token', document.getElementById('ghToken').value); alert("Login Salvato"); }
    async function uploadPDF() {
        let r=document.getElementById('ghRepo').value, t=document.getElementById('ghToken').value, n=document.getElementById('pdfName').value, f=document.getElementById('pdfFile').files[0], s=document.getElementById('upStatus');
        if(!r||!t||!n||!f) return alert("Dati mancanti");
        s.innerText="Upload...";
        let reader = new FileReader();
        reader.onload = async function() {
            try {
                let url=`https://api.github.com/repos/${r}/contents/spesa/volantini/${n.toLowerCase().replace(/\s/g,'')}.pdf`;
                let sha=null; try{let c=await fetch(url,{headers:{Authorization:`token ${t}`}}); if(c.ok) sha=(await c.json()).sha;}catch(e){}
                let res=await fetch(url,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:"Up",content:reader.result.split(',')[1],sha:sha})});
                if(!res.ok) throw new Error("Err Github");
                s.innerText="Fatto! Analisi in corso...";
            } catch(e) { s.innerText="Errore: "+e.message; }
        };
        reader.readAsDataURL(f);
    }
    
    function hardReset() { if(confirm("Reset Totale?")) { localStorage.clear(); location.reload(); } }
    function go(p,b) { document.querySelectorAll('.page').forEach(x=>x.classList.remove('active')); document.getElementById(p).classList.add('active'); document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAll(); }
    function renderAll() { renderMenu(); renderShop(); renderOffers(); }

    init();
</script>
</body>
</html>
