<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pizze Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e74c3c">
    <style>
        :root {
            --primary: #e74c3c;
            --secondary: #f1c40f;
            --bg: #f0f2f5;
            --text: #333;
            --card-bg: #fff;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center; }
        h1 { margin: 0; font-size: 1.3rem; }

        /* Search Bar & Filters */
        .search-container { padding: 1rem; background: white; border-bottom: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input[type="text"], select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
        .filter-chip { background: #eee; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; white-space: nowrap; border: none; transition: all 0.2s; font-weight: 500; }
        .filter-chip.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3); }

        /* Pizza List & Cards */
        .pizza-list { padding: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.2rem; }
        .pizza-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.08); position: relative; border-top: 4px solid #ccc; transition: transform 0.2s; }
        .pizza-card.Rossa { border-top-color: var(--primary); }
        .pizza-card.Bianca { border-top-color: #bdc3c7; }

        .pizza-img-container { width: 100%; height: 180px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .pizza-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .pizza-placeholder { color: #aaa; font-size: 3rem; }

        .card-content { padding: 1rem; padding-top: 1.5rem; } /* Extra padding top for buttons */
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .pizza-name { font-weight: 700; font-size: 1.2rem; color: #2c3e50; }
        .pizza-season { font-size: 0.7rem; background: #e8f5e9; color: #27ae60; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .pizza-ingredients { font-size: 0.95rem; color: #555; line-height: 1.5; }
        
        /* Action Buttons on Card */
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 10; }
        .action-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: none; }
        .edit-btn { background: white; color: #2980b9; }
        .delete-btn { background: white; color: #c0392b; }

        /* Add Modal */
        #addModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); animation: slideUp 0.3s ease-out; }
        @media (min-width: 600px) {
             #addModal { align-items: center; }
             .modal-content { border-radius: 20px; width: 90%; }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-title { margin-top: 0; display:flex; justify-content:space-between; align-items:center; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 14px 20px; border-radius: 10px; width: 100%; font-size: 1.1rem; font-weight: 600; margin-top: 15px; cursor: pointer; }
        .btn-secondary { background: #eee; color: #555; border: none; padding: 12px; border-radius: 10px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: 600; }

        /* Image Upload Styles */
        .image-upload-label { display: block; margin-bottom: 10px; font-weight: 600; color: #555; }
        .file-input-container { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-button { background: #3498db; color: white; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; display: block; font-weight: 600; }
        #newImageInput { position: absolute; font-size: 100px; opacity: 0; right: 0; top: 0; cursor: pointer; }
        #imagePreviewContainer { margin-top: 15px; text-align: center; display: none; position: relative; }
        #imagePreview { max-width: 100%; max-height: 200px; border-radius: 12px; border: 2px solid #eee; }
        .remove-img-btn { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; border:none; cursor: pointer; display:none; }

        /* Floating Action Button */
        .fab { position: fixed; bottom: 25px; right: 25px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); cursor: pointer; border: none; transition: transform 0.2s; z-index: 90; }
        .fab:active { transform: scale(0.95); }

    </style>
</head>
<body>

<header>
    <h1>üçï Archivio Pizze</h1>
    <div style="font-size:0.8rem; opacity:0.8;">v2.1</div>
</header>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="Cerca pizza o ingrediente..." onkeyup="renderPizzas()">
    <div class="filters">
        <button class="filter-chip active" onclick="setFilter('Tutte', this)">Tutte</button>
        <button class="filter-chip" onclick="setFilter('Rossa', this)">Rosse</button>
        <button class="filter-chip" onclick="setFilter('Bianca', this)">Bianche</button>
    </div>
    <div class="filters" style="margin-top: 8px;">
        <select id="seasonFilter" onchange="renderPizzas()" style="margin:0; padding: 8px; font-size: 0.9rem; border-radius: 20px; background: #eee; border:none;">
            <option value="">üìÖ Tutte le stagioni</option>
            <option value="Tutto l'anno">Tutto l'anno</option>
            <option value="Estate">Estate</option>
            <option value="Inverno">Inverno</option>
            <option value="Primavera">Primavera</option>
            <option value="Autunno">Autunno</option>
        </select>
    </div>
</div>

<div class="pizza-list" id="pizzaList">
    </div>

<button class="fab" onclick="openModal()">+</button>

<div id="addModal">
    <div class="modal-content">
        <h2 class="modal-title" id="modalTitle">Nuova Pizza</h2>
        
        <label class="image-upload-label">Foto della Pizza</label>
        <div class="file-input-container">
            <label for="newImageInput" class="file-input-button">
                üì∑ Scatta o Seleziona Foto
            </label>
            <input type="file" id="newImageInput" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
        </div>
        <div id="imagePreviewContainer">
             <img id="imagePreview" src="" alt="Anteprima">
             <canvas id="compressionCanvas" style="display:none;"></canvas>
        </div>
        <br>

        <input type="text" id="newName" placeholder="Nome Pizza (es. Margherita)">
        <select id="newCategory">
            <option value="Bianca">Categoria: Bianca</option>
            <option value="Rossa">Categoria: Rossa</option>
        </select>
        <select id="newSeason">
            <option value="Tutto l'anno">Stagionalit√†: Tutto l'anno</option>
            <option value="Primavera">Primavera</option>
            <option value="Estate">Estate</option>
            <option value="Autunno">Autunno</option>
            <option value="Inverno">Inverno</option>
        </select>
        <textarea id="newIngredients" rows="4" placeholder="Ingredienti separati da virgola (es. pomodoro, mozzarella, basilico)"></textarea>
        
        <button class="btn-primary" onclick="savePizza()">Salva Pizza</button>
        <button class="btn-secondary" onclick="closeModal()">Annulla</button>
    </div>
</div>

<script>
    // DATI CSV ORIGINALI
    const rawCsvData = `id,Nome,Categoria,Ingrediente1,Ingrediente2,Ingrediente3,Ingrediente4,Ingrediente5,Ingrediente6,Ingrediente7,Ingrediente8,Ingrediente9,Ingrediente10
1,Margherita,Rossa,pomodoro,fior di latte,,parmigiano,,parmigiano,basilico,,olio,sale
2,Margherita con bufala,Rossa,pomodoro,mozzarella di bufala,,parmigiano,,parmigiano,basilico,,olio,sale
3,Bianca,Bianca,,,,,,,,,olio,sale
4,Rossa con origano,Rossa,pomodoro,,,,,,origano,,olio,sale
5,Patate,Bianca,patate,,,,,,rosmarino,,olio,sale
6,Zucchine,Bianca,zucchine,fior di latte,,,,,,,olio,sale
7,Funghi bianca,Bianca,funghi,fior di latte,,,,,prezzemolo,,olio,sale
8,Amatriciana,Rossa,pomodoro,guanciale,,,,pecorino,,pepe,olio,sale
9,Carbonara,Bianca,uovo,guanciale,,,,pecorino,,pepe,olio,sale
10,Cacio e Pepe,Bianca,ghiaccio,,,,,pecorino,,pepe,olio,sale
11,"Gorgonzola, mozzarella, in uscita pere (sottili), guanciale croccante e miele",Bianca,gorgonzola,pere,guanciale,miele,fior di latte,,,,olio,sale
12,"Base rossa, melanzane grigliate in uscita capocollo e burrata",Rossa,pomodoro,melanzane,capocollo,burrata,,,,,olio,sale
13,Broccoletti e salsiccia,Bianca,broccoletti,salsiccia,,,,,,,olio,sale
14,Patate e salsiccia,Bianca,patate,salsiccia,,,,,,,olio,sale
15,Provola affumicata e speck,Bianca,provola,speck,fior di latte,,,,,,olio,sale
16,Vergure grigliate,Bianca,zucchine,melanzane,peperoni,fior di latte,,,,,olio,sale
17,"Base rossa, bresaola rughetta e parmigiano",Rossa,pomodoro,bresaola,rughetta,parmigiano,,,,,olio,sale
18,Stracchino e ciasculo,Bianca,stracchino,ciauscolo,fior di latte,,,,,,olio,
19,"Zucchine, melanzane e peperoni",Bianca,zucchine,melanzane,peperoni,,,,,,olio,sale
20,Zucca e speck,Bianca,zucca,speck,,,,,,,olio,sale
21,"Fiori di zucca, crema di zucchine e alici",Bianca,fiori di zucca,zucchine,alici,,,,,,olio,sale
22,"Nduia, peperoni, alici, cipolla, rosmarino e bufala in uscita",Bianca,nduia,peperoni,alici,cipolla,mozzarella di bufala,,rosmarino,,olio,sale
23,Pizza fritta pomodoro e parmigiano,Rossa,pomodoro,,,,,parmigiano,basilico,,olio,sale
24,Cicoria e salsiccia,Bianca,salsiccia,cicoria,peperoncino,,,,,,olio,sale
25,"Crema di ceci, mortadella, limone",Bianca,ceci,mortadella,limone,,,,,,olio,sale
26,Asparagi e crema di pecorino,Bianca,asparagi,,,,,pecorino,,,olio,sale
27,Cime di rapa e salsiccia,Bianca,cime di rapa,salsiccia,,,,,,,olio,sale
28,Funghi rossa,Rossa,pomodoro,funghi,fior di latte,,,,,,olio,sale
29,Boscaiola bianca,Bianca,funghi,salsiccia,mozzarella,,,,,,olio,sale
30,Zucca e grana,Bianca,zucca,parmigiano,,,,,,,olio,sale
31,Zucca e gorgonzola,Bianca,zucca,gorgonzola,,,,,,,olio,sale
32,"Zucchine, ciauscolo e cipolla",Bianca,zucchine,ciauscolo,cipolla,,,,,,olio,sale
33,"Base rossa, ricotta e granella di pistacchio",Rossa,pomodoro,ricotta,pistacchio,,,,,,olio,sale
34,"Crema di asparagi, punte di asparagi e speck croccante in uscita",Bianca,asparagi,speck,,,,,,,olio,sale
35,Tonno e cipolla,Rossa,pomodoro,tonno,cipolla,,,,,,olio,sale
36,Peperoni e salsiccia,Bianca,peperoni,salsiccia,,,,,,,olio,sale
37,Mela e lardo di colonnata,Bianca,mela,lardo,,,,,,,olio,sale
38,Focaccia bianca,Bianca,,,,,,,,,olio,sale
39,"Focaccia pomodorini, olive nere e origano",Bianca,pomodorini,olive nere,,,,,origano,,olio,sale
40,Melanzane,Bianca,melanzane,fior di latte,,,,,,,olio,sale
41,Gorgonzola,Bianca,gorgonzola,fior di latte,,,,,,,olio,sale
42,4 Formaggi,Bianca,gorgonzola,parmigiano,stracchino,pecorino,,,,,olio,sale
43,"Mortadella, Maionese di Pistacchio e Stracciatella in uscita",Bianca,mortadella,pistacchio,stracciatella,,,,,,olio,sale
44,"Patate, Stracchino e Cipolla",Bianca,patate,stracchino,cipolla,,,,,,olio,sale
45,Margherita con Prosciutto crudo,Rossa,pomodoro,prosciutto crudo,,,,,,,olio,sale
46,"Bieta, Olive nere e Peperoncino",Bianca,bieta,olive nere,peperonicino,,,,,,olio,sale
47,"Cipolline Borretane in agro dolce, Fior di Latte, Alici e Pecorino Romano",Bianca,cipolle,fior di latte,alici,zucchero,aceto,pecorino,,,olio,sale
48,"Base rossa, puntarelle con olio e aceto e Alici",Rossa,pomodoro,puntarelle,aceto,alici,,,,,olio,sale
49,Crostino (Cotto e Mozzarella),Bianca,prosciutto cotto,fior di latte,,,,,,,olio,sale
50,Broccoletti stufati con alici e pecorino,Bianca,broccoletti,alici,,,,pecorino,,,olio,sale
51,"Base rossa, Peperoni al forno con Alici, Capperi, Olive verdi e Pane grattato",Rossa,peperoni,alici,capperi,olive verdi,pane grattato,,,,olio,sale
52,Patate al forno (aglio e rosmarino) e Mozzarella,Bianca,patate,fior di latte,aglio,,,,rosmarino,,olio,sale
53,"Crema di Friarielli (con latte di Bufala Affumicata), Fiordilatte, Bufala Affumicata e salsiccia",Bianca,friarielli,mozzarella di bufala affumicata,fior di latte,salsiccia,,,,,olio,sale
54,"Crema di Zucchine, Melanzane Grigliate, Ricotta e Parmigiano",Bianca,zucchine,melanzane,ricotta,,,parmigiano,,,olio,sale
55,"Patate, fiori di zucca, pesto alla genovese e fior di latte",Bianca,patate,fiori di zucca,pesto,fior di latte,,,,,olio,sale
56,"Carciofi alla romana, guanciale e pecorino",Bianca,carciofi,guanciale,,,aglio,pecorino,mentuccia,,olio,sale
57,"Cicoria ripassata, alici e pecorino",Bianca,cicoria,alici,,,,pecorino,,,olio,sale
58,"Base bianca, squacquerone, prosciutto crudo",Bianca,prosciutto crudo,squacquerone,,,,,,,olio,sale
59,Base rossa pomodorini confit e stracciatella in uscita,Rossa,pomodoro,pomodorini,zucchero,stracciatella,,,,,olio,sale
60,"Base bianca, fave (poca mozzarella e met√† cottura) e pecorino in uscita",Bianca,fave,fior,,,,pecorino,,,olio,sale
61,Fiori di zucca alici e ricotta,Bianca,fiori di zucca,alici,ricotta,,,,,,olio,sale
62,Fiori di zucca prosciutto cotto (mozzarella o ricotta),Bianca,fiori di zucca,prosciutto cotto,fior di latte,,,,,,olio,sale
63,Carciofi alla romana prosciutto arrosto alla griglia e stracciatella in uscita,Bianca,carciofi,prosciutto arrosto,stracciatella,,,,,,olio,sale
64,Zucchine mozzarella e stracchino (prova foglioline di menta),Bianca,stracchino,fior di latte,,,,,menta,,olio,sale
65,Zucchine e in uscita salmone affumicato e stracciatella,Bianca,zucchine,salmone affumicato,stracciatella,,,,,,olio,sale
66,"Prosciutto cotto al forno, mozzarella e funghi champignon",Bianca,prosciutto cotto al forno,fior di latte,funghi,,,,,,olio,sale
67,"Peperoni cornetti, cipolle, mozzarella e gorgonzola",Bianca,peperoni cornetti,cipolla,fior di latte,gorgonzola,,,,,olio,sale
68,"Crema di patate (pur√©),scamorza affumicata, fiori di zucca, fior di latte",Bianca,patate,scamorza affumicata,fiori di zucca,fior di latte,,,,,olio,sale
69,"Base rossa, scarola, alici, uvetta, pinoli",Rossa,scarola,uvetta,alici,pinoli,,,,,olio,sale
70,"Crema di zucca, patate, fior di latte, gorgonzola",Bianca,patate,fior di latte,zucca,gorgonzola,,,,,olio,sale
71,Norma a modo mio,Rossa,melanzane,ricotta salata,parmigliano,,,,,,olio,sale
72,"Base rossa, rughetta, crudo e bufala",Rossa,pomodoro,prosciutto crudo,rughetta,bufala,,,,,olio,sale
73,"Base bianca, stracchino, gorgonzola e speck in uscita",Bianca,gorgonzola,stracchino,speck,,,,,,olio,sale
74,"Base bianca, carciofi alla romana, pancetta tesa, saba",Bianca,carciofi,pancetta,saba,,,,,,olio,sale`;

    let pizzas = [];
    let currentFilter = 'Tutte';
    let tempImageBase64 = null; 
    let editingPizzaId = null; // ID della pizza che stiamo modificando (null se nuova)

    // Inizializzazione
    function init() {
        const stored = localStorage.getItem('pizzaDb_v2'); 
        if (stored) {
            pizzas = JSON.parse(stored);
        } else {
            parseCSV(rawCsvData);
        }
        renderPizzas();
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    }

    // Parser CSV
    function parseCSV(csv) {
        const lines = csv.split('\n');
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if(!line) continue;
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(parts.length < 3) continue;

            const name = parts[1].replace(/"/g, '').trim();
            const cat = parts[2].trim();
            const ingredients = [];
            for(let j=3; j<=12; j++) {
                if(parts[j] && parts[j].trim() !== '') {
                    ingredients.push(parts[j].replace(/"/g, '').trim().toLowerCase());
                }
            }

            pizzas.push({
                id: Date.now() + i,
                name: name,
                category: cat,
                season: "Tutto l'anno",
                ingredients: ingredients,
                image: null
            });
        }
        saveData();
    }

    function saveData() {
        try {
            localStorage.setItem('pizzaDb_v2', JSON.stringify(pizzas));
            renderPizzas();
        } catch (e) {
            alert("Memoria piena! Impossibile salvare. Prova a cancellare qualche foto.");
        }
    }

    // --- GESTIONE IMMAGINI ---
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.getElementById('compressionCanvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 400;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                tempImageBase64 = canvas.toDataURL('image/jpeg', 0.7);

                document.getElementById('imagePreview').src = tempImageBase64;
                document.getElementById('imagePreviewContainer').style.display = 'block';
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }


    // --- FUNZIONI UI ---

    function setFilter(type, btn) {
        currentFilter = type;
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderPizzas();
    }

    function renderPizzas() {
        const list = document.getElementById('pizzaList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const seasonFilter = document.getElementById('seasonFilter').value;
        
        list.innerHTML = '';

        const filtered = pizzas.filter(pizza => {
            if (currentFilter !== 'Tutte' && pizza.category !== currentFilter) return false;
            if (seasonFilter && pizza.season !== seasonFilter) return false;
            const matchName = pizza.name.toLowerCase().includes(search);
            const matchIng = pizza.ingredients.some(ing => ing.includes(search));
            return matchName || matchIng;
        });

        filtered.forEach(pizza => {
            const div = document.createElement('div');
            div.className = `pizza-card ${pizza.category}`;
            
            const imageHtml = pizza.image 
                ? `<div class="pizza-img-container"><img src="${pizza.image}" alt="${pizza.name}" loading="lazy"></div>`
                : `<div class="pizza-img-container"><span class="pizza-placeholder">üçï</span></div>`;

            // Nota: ho aggiunto il div "card-actions" con il pulsante Edit e Delete
            div.innerHTML = `
                <div class="card-actions">
                    <button class="action-btn edit-btn" onclick="openModal(${pizza.id})">‚úèÔ∏è</button>
                    <button class="action-btn delete-btn" onclick="deletePizza(${pizza.id})">&times;</button>
                </div>
                ${imageHtml}
                <div class="card-content">
                    <div class="card-header">
                        <div class="pizza-name">${pizza.name}</div>
                        <span class="pizza-season">${pizza.season}</span>
                    </div>
                    <div class="pizza-ingredients">
                        ${pizza.ingredients.join(', ')}
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Apre il modale (Vuoto se new, Popolato se edit)
    function openModal(pizzaId = null) {
        editingPizzaId = pizzaId; // Salviamo l'ID se stiamo modificando

        // Reset campi base
        document.getElementById('newImageInput').value = '';
        document.getElementById('imagePreviewContainer').style.display = 'none';
        tempImageBase64 = null;

        if (pizzaId) {
            // MODALIT√Ä MODIFICA
            const pizza = pizzas.find(p => p.id === pizzaId);
            if (!pizza) return;

            document.getElementById('modalTitle').innerText = "Modifica Pizza";
            document.getElementById('newName').value = pizza.name;
            document.getElementById('newCategory').value = pizza.category;
            document.getElementById('newSeason').value = pizza.season;
            document.getElementById('newIngredients').value = pizza.ingredients.join(', ');
            
            // Se c'√® gi√† una foto, mostrala e salvala nella variabile temporanea
            if (pizza.image) {
                tempImageBase64 = pizza.image;
                document.getElementById('imagePreview').src = pizza.image;
                document.getElementById('imagePreviewContainer').style.display = 'block';
            }

        } else {
            // MODALIT√Ä NUOVA PIZZA
            document.getElementById('modalTitle').innerText = "Nuova Pizza";
            document.getElementById('newName').value = '';
            document.getElementById('newIngredients').value = '';
            document.getElementById('newSeason').value = "Tutto l'anno";
        }

        document.getElementById('addModal').style.display = 'flex'; 
    }
    
    function closeModal() { document.getElementById('addModal').style.display = 'none'; }

    function savePizza() {
        const name = document.getElementById('newName').value;
        const cat = document.getElementById('newCategory').value;
        const season = document.getElementById('newSeason').value;
        const ingRaw = document.getElementById('newIngredients').value;
        
        if(!name) return alert("Inserisci il nome della pizza!");

        const ingredients = ingRaw.split(',').map(s => s.trim().toLowerCase()).filter(s => s);

        if (editingPizzaId) {
            // MODIFICA ESISTENTE
            const index = pizzas.findIndex(p => p.id === editingPizzaId);
            if (index !== -1) {
                pizzas[index].name = name;
                pizzas[index].category = cat;
                pizzas[index].season = season;
                pizzas[index].ingredients = ingredients;
                // Aggiorna foto solo se √® stata caricata o se esisteva gi√† (la variabile tempImageBase64 gestisce entrambi i casi)
                pizzas[index].image = tempImageBase64; 
            }
        } else {
            // AGGIUNTA NUOVA
            pizzas.unshift({ 
                id: Date.now(),
                name: name,
                category: cat,
                season: season,
                ingredients: ingredients,
                image: tempImageBase64 
            });
        }

        saveData();
        closeModal();
    }

    function deletePizza(id) {
        // Evita che il click sul delete propaghi e magari apra il modale per sbaglio (se il layout cambiasse)
        if(confirm('Sei sicuro di voler eliminare questa pizza?')) {
            pizzas = pizzas.filter(p => p.id !== id);
            saveData();
        }
    }

    // Avvio
    init();

</script>

</body>
</html>